<!DOCTYPE html>
    <head>
        <title>樱花飞舞季｜日系好物展</title>
        <meta charset="utf-8">
         <meta name="viewport" content="viewport-fit=cover, width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <style>
            html{
                height:100%;
                min-height:100%;
            }
            body{
                min-height:100%;
            }
            body {
                position: fixed;
                top: 0;
                right: 0;
                bottom: 0;
                left: 0;
                font-family: Monospace;
                background-color: #fff;
                margin: 0px;
                overflow: hidden;
                background-image: url(./textures/bg.jpg?t=asdff);
                background-position: center center;
                background-repeat: no-repeat;
                background-attachment: fixed;
                background-size: cover;

            }
            #info {
                position: absolute;
                top: 0px;
                width: 100%;
                padding: 5px;
                text-align:center;
            }

           #cover {
                margin: 0px;
                padding:0;
                height: auto;
                width: 100vw;
                min-height: 100vh;
                display:block;
                background-image: url(./textures/start.jpg?t=asdxxxxxff);
                background-position: center center;
                background-repeat: no-repeat;
                background-size: cover;
                position: fixed;
                overflow: hidden;
            }


           .progress {
             width: 200px;
             height: 20px;
             background: #000;
             border: 2px solid #000;
           }
          .progressBar {
             width: 200px;
             height: 20px;
             background: red;
             border: none;
           }

        </style>
    </head>
    <body>
        <div style="display:none;text-align:center;width:100%;font-size:1.2rem;position: absolute;color:red;margin-top:10px;" id="button" >
            <img src="textures/button_top.png?t=aasdkjf"style="width:70%;" />
        </div>
            <div id="cover" >
            </div>
                <canvas id="canvas" style="display:none;position:absolute; left:100px"> </canvas>
        <script src="./three.min.js"></script>
        <!-- <script src="./tween.min.js"></script> -->
        <script src="./Projector.js"></script>
        <script>
        

       var start = function(){
             document.getElementById("button").style.display = "block";
             document.getElementById("canvas").style.display = "block";
             setTimeout(function(){
                 document.getElementById("cover").style.background = "#ffffff9c";
             }, 100)
             setTimeout(function(){
                     document.getElementById("cover").style.display = "none";
             }, 1000)
             setTimeout(function(){
                 document.getElementById("button").style.display = "none";
             }, 3000)

             if (particles.length > sakura_len){
                 animate();
             }else{
                 alert('error');
             }
       }

     
       var defaultOrientation; // window.orientationが0または180の時に縦長であればtrue

       window.addEventListener('load', function() {
         if('orientation' in window) {
             var o1 = (window.innerWidth < window.innerHeight);
             var o2 = (window.orientation % 180 == 0);
             defaultOrientation = (o1 && o2) || !(o1 || o2);
             checkOrientation();
           }
         });

       var event = navigator.userAgent.match(/(iPhone|iPod|iPad)/) ? 'orientationchange' : 'resize';

       window.addEventListener(event, checkOrientation, false);
       function checkOrientation () {
         if('orientation' in window) {
                     var o = (window.orientation % 180 == 0);
             if((o && defaultOrientation) || !(o || defaultOrientation)) {
                   // ここに縦長画面への切り替え処理を記述
                         console.log('portrait');
                         //init();
                         // animate();
                 }
             else {
                   // ここに横長画面への切り替え処理を記述
                         // console.log('landscape');
                         alert('水平屏幕不支持');
                         document.getElementById("cover").style.display = "block";
                 }
           }
       };



        let camera, scene, renderer ,stats,container,particle,particles,geo;
        let mesh;
        let projector = new THREE.Projector();
        let mouse = { x: 0, y: 0 };  
        let targetList = [];
        let count = 0;
        let clicked = 0
        let LENGTH   = 16
        let sakura_len = 60
        let box_len = 10
        const speed = 5;
        let frame = 0;
        var texture = new THREE.TextureLoader().load( 'textures/intro_sakura2.png' );
        var texture2 = new THREE.TextureLoader().load( 'textures/box1.png' );
        var texture3 = new THREE.TextureLoader().load( 'textures/box2.png' );
        var texture4 = new THREE.TextureLoader().load( 'textures/box3.png' );
        var texture5 = new THREE.TextureLoader().load( 'textures/box4.png' );
        var textures = [texture2,texture3,texture4,texture5]
        function won_name(won){
         
            switch(won) {
                case 0:
                    return 'ReFa'
                    break;
                case 1:
                    return 'Chulabi'
                    break;
                case 2:
                    return 'Ohta'
                    break;
                case 3:
                    return 'ECOTT COSME'
                    break;
            } 
        }
        window.onload = init();
        let swings = []
        function init() {
            document.getElementById("cover").addEventListener( 'touchstart',function(ev){
                start();
            }, false ); 
            particles = [];
            container = document.createElement( 'div' );
            document.body.appendChild( container );
            camera = new THREE.PerspectiveCamera( 70, window.innerWidth / window.innerHeight, 1, 8000 );
            camera.position.z = 500;
            camera.position.x = -100;
            camera.lookAt(new THREE.Vector3(0, 10, 0));
            scene = new THREE.Scene();

            const directionalLight = new THREE.DirectionalLight(0xFFFFFF);
            directionalLight.position.set(1, 1, 1);
            scene.add(directionalLight);
            var geo = new THREE.PlaneGeometry( 90, 90,10,10 ); 
            var wireframe = false;
            var geometry = new THREE.SphereGeometry(20, 8, 4, 0, Math.PI);
            var colors = [0xf4e8f2,0xf8d6e5,0xfad8e6]
            for (var i = 0; i < box_len + sakura_len; i++) {
                const won = parseInt(Math.random() * 4)
                const material = new THREE.MeshBasicMaterial({wireframe: wireframe,color: colors[parseInt(Math.random() * 3) ],map: texture,transparent: true, side: THREE.DoubleSide ,  alphaTest:0.1});
                const mat = new THREE.MeshBasicMaterial({wireframe: wireframe,map: textures[won],transparent: true, side: THREE.DoubleSide });
                if (i < sakura_len){
                    particle = new THREE.Mesh( geometry, material );
                    particle.rotation.y += Math.random() * 0.15;
                    particle.rotation.x -= Math.random() * 100;
                    particle.rotation.x -= Math.random() * 100;
                    particle.position.x = randomRange(-400,400)
                    particle.position.z = Math.random() * 300 - 400;
                    particle.position.y = Math.random() * 2000 - 1000;
                }else{
                    particle = new THREE.Mesh( geo, mat );
                    particle.position.x = randomRange(-50,320)
                    particle.position.z = randomRange(-100,100)
                    particle.position.y =  randomRange(1100,300);
                }
                particle.scale.y = 1.3;
                particle.scale.z = 0.8;

               particle.name = won_name(won) 
               scene.add( particle );
                particles.push(particle); 
            }
            renderer = new THREE.WebGLRenderer( { antialias: true, alpha: true } ); 
            renderer.setPixelRatio( 1.5 );
            renderer.setSize( window.innerWidth, window.innerHeight );
            renderer.setClearColor( new THREE.Color(0xffffff),0.0);//背景色 )
            renderer.setPixelRatio(window.devicePixelRatio)

            window.addEventListener( 'resize', onWindowResize, false );
            container.appendChild( renderer.domElement );
            window.addEventListener( 'touchstart', onDocumentTouchStart, false ); 
        }


        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize( window.innerWidth, window.innerHeight );
        }

        function onDocumentTouchStart( ev ) {

            if ( ev.touches.length == 1 ) {
                // ev.preventDefault();
                var rect = ev.target.getBoundingClientRect();    
                mouse.x =  ev.touches[0].clientX - rect.left
                mouse.y =  ev.touches[0].clientY - rect.top
                mouse.x =  (mouse.x / window.innerWidth) * 2 - 1
                mouse.y = -(mouse.y / window.innerHeight) * 2 + 1
                var vector = new THREE.Vector3( mouse.x, mouse.y ,1);
                vector.unproject(camera);
                var ray = new THREE.Raycaster( camera.position, vector.sub(camera.position).normalize() );
                var obj = ray.intersectObjects( particles,true)

                clicked = 0
                let name 
                if ( obj.length > 0 ){                       
                    for(var i = 0; i < particles.length; i++){
                      if (particles[i].uuid == obj[0].object.uuid){
                         name = particles[i].name
                         particles[i].position.y += 20;
                         particles[i].position.z -= 10;
                         clicked = i
                      };
                       particles[i].position.y += 1;
                    }
                    count += 1;
                    setTimeout(()=>{
                        alert(name)
                    },1000)
                } 

            }
        }

        var maxRotation = Math.PI / 3;
        var minRotation = Math.PI / 4;
        function animate() {
            requestAnimationFrame( animate );
            frame++;
            if(frame % 2 == 0) { return; }

            for(var i = 0; i<particles.length; i++) {
               if (clicked == i){
                   particles[i].rotation.z +=  1;
               }else{
                   if (i < sakura_len){
                       particles[i].rotation.y += Math.random() * 0.4;
                       particles[i].rotation.x -= Math.random() * 0.2;
                   }else{
                       particles[i].rotationMove = +0.003
                       if (particles[i].position.y < 0){
                           particles[i].rotationMove = -0.01
                       }
                       particles[i].rotation.z += particles[i].rotationMove                       
                   }
               }

               // console.log(swings.length)
               if(particles[i].position.y < -380 ){
                   particles[i].position.y +=  760;
                   particles[i].rotation.z =  0;
                   particles[i].rotation.y +=  0;
                   particles[i].rotation.x +=  0;
               }else{
                   if (clicked == i){
                       particles[i].position.y +=  speed;
                   }else{
                       particles[i].position.y -=  speed;
                   }
               }
               // console.log(particles[i].position.x)
               if(particles[i].position.x < -250){
                   particles[i].position.x +=  500;
               }else{
                   if (clicked == i){
                       particles[i].position.x -=   1 
                   }else{
                       if (particles[i].position.y > Math.random() * 10){
                           particles[i].position.x -=   2;
                       }else{
                           particles[i].position.x +=   1;
                       }
                   }
               }

           }    
            renderer.render( scene, camera );
        }

        function randomRange(min, max) {
            return ((Math.random() * (max - min)) + min);
        }

       function cameraPosition(x,y,z){
           new TWEEN.Tween({x: camera.position.x,y: camera.position.y,z: camera.position.z})
               .to({x:x,y:y,z:z}, 1000)
               .onUpdate(function () {
                   camera.position.set(this.x,this.y,this.z)
                  camera.lookAt(new THREE.Vector3(0, 0, 0))
               })
                 .onComplete(function () {
                       camera.lookAt(new THREE.Vector3(0, 0, 0))
               }).start()
       }
       function swing(i){
               // particles[i].rotation.z += 0.01;
       }

        </script>
    </body>
</html>
